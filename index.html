<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS System - Advanced 3D Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #00d4ff;
            overflow: hidden;
            height: 100vh;
        }

        .jarvis-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-column: 1 / 4;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px #00d4ff;
        }

        .status-indicators {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        .status-dot.inactive {
            background: #ff0000;
            box-shadow: 0 0 10px #ff0000;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sidebar {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid #00d4ff;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
        }

        .tool-button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 8px;
            color: #00d4ff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .tool-button:hover, .tool-button.active {
            background: rgba(0, 212, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            transform: translateX(5px);
        }

        .main-workspace {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid #00d4ff;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .workspace-content {
            width: 100%;
            height: 100%;
            display: none;
            position: relative;
        }

        .workspace-content.active {
            display: block;
        }

        /* Camera and Gesture Canvas */
        #input_video {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 240px;
            height: 180px;
            border: 2px solid #00d4ff;
            border-radius: 8px;
            transform: scaleX(-1);
            z-index: 200;
            display: none;
        }

        #input_video.active {
            display: block;
        }

        #output_canvas {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 240px;
            height: 180px;
            border: 2px solid #00d4ff;
            border-radius: 8px;
            transform: scaleX(-1);
            z-index: 201;
            display: none;
        }

        #output_canvas.active {
            display: block;
        }

        /* Virtual Cursor */
        .virtual-cursor {
            position: fixed;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(0, 212, 255, 0.6);
            border: 3px solid #00ff00;
            pointer-events: none;
            z-index: 9999;
            display: none;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
            transition: all 0.05s ease;
        }

        .virtual-cursor.active {
            display: block;
        }

        .virtual-cursor.clicking {
            background: rgba(255, 0, 0, 0.8);
            transform: scale(1.5);
        }

        .virtual-cursor.drawing {
            background: rgba(255, 255, 0, 0.8);
            border-color: #ffff00;
        }

        /* Drawing Canvas */
        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            background: rgba(10, 14, 39, 0.8);
        }

        /* 3D Viewer */
        #modelViewer {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            position: relative;
        }

        /* Browser */
        #browserFrame {
            width: 100%;
            height: calc(100% - 50px);
            border: none;
            background: white;
        }

        .browser-controls {
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .url-input {
            flex: 1;
            padding: 8px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 5px;
            color: #00d4ff;
        }

        .drawing-tools {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #00d4ff;
            z-index: 100;
        }

        .color-picker, .size-picker {
            margin: 10px 0;
        }

        /* 3D Controls Panel */
        .model-controls-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #00d4ff;
            z-index: 100;
            max-width: 280px;
            max-height: calc(100% - 20px);
            overflow-y: auto;
        }

        .model-controls-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
        }

        .model-controls-section:last-child {
            border-bottom: none;
        }

        .model-controls-section h4 {
            color: #00d4ff;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .control-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            border-radius: 5px;
            color: #00d4ff;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .control-button:hover {
            background: rgba(0, 212, 255, 0.4);
            transform: scale(1.05);
        }

        .control-button.small {
            display: inline-block;
            width: calc(50% - 5px);
            padding: 8px;
            font-size: 12px;
        }

        .control-slider {
            width: 100%;
            margin: 8px 0;
        }

        .control-label {
            font-size: 12px;
            color: #00d4ff;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .object-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .object-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .object-item:hover {
            background: rgba(0, 212, 255, 0.3);
        }

        .object-item.selected {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
        }

        .delete-object {
            background: rgba(255, 0, 0, 0.3);
            border: 1px solid #ff0000;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .delete-object:hover {
            background: rgba(255, 0, 0, 0.5);
        }

        .chat-panel {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid #00d4ff;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 15px;
            background: rgba(0, 212, 255, 0.1);
            border-bottom: 1px solid #00d4ff;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-button {
            padding: 5px 10px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            border-radius: 5px;
            color: #00d4ff;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .toggle-button.active {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            max-width: 90%;
            word-wrap: break-word;
        }

        .message.user {
            background: rgba(0, 212, 255, 0.2);
            margin-left: auto;
            text-align: right;
        }

        .message.jarvis {
            background: rgba(0, 255, 100, 0.2);
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #00d4ff;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 5px;
            color: #00d4ff;
            font-size: 14px;
        }

        .send-button {
            padding: 10px 20px;
            background: rgba(0, 212, 255, 0.3);
            border: 1px solid #00d4ff;
            border-radius: 5px;
            color: #00d4ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-button:hover {
            background: rgba(0, 212, 255, 0.5);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        /* Virtual Keyboard */
        .virtual-keyboard {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00d4ff;
            border-radius: 10px;
            padding: 20px;
            display: none;
            z-index: 2000;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        }

        .virtual-keyboard.active {
            display: block;
        }

        .keyboard-row {
            display: flex;
            gap: 5px;
            margin: 5px 0;
            justify-content: center;
        }

        .key {
            padding: 12px 16px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            border-radius: 5px;
            color: #00d4ff;
            cursor: pointer;
            min-width: 45px;
            text-align: center;
            transition: all 0.2s;
            font-size: 14px;
        }

        .key:hover, .key:active {
            background: rgba(0, 212, 255, 0.5);
            transform: scale(1.1);
        }

        .key.space {
            flex: 3;
        }

        /* Gesture Indicator - Repositioned to bottom right */
        .gesture-indicator {
            position: fixed;
            bottom: 20px;
            right: 380px;
            background: rgba(0, 0, 0, 0.95);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #00d4ff;
            z-index: 1500;
            min-width: 250px;
            max-width: 300px;
            display: none;
        }

        .gesture-indicator.active {
            display: block;
        }

        .gesture-text {
            font-size: 16px;
            font-weight: bold;
            margin: 8px 0;
        }

        .hand-info {
            font-size: 11px;
            margin: 4px 0;
            padding: 4px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 4px;
        }

        .hand-info.right {
            border-left: 3px solid #00ff00;
        }

        .hand-info.left {
            border-left: 3px solid #ffaa00;
        }

        .gesture-help {
            font-size: 10px;
            line-height: 1.4;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #00d4ff;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 212, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: #00d4ff;
            border-radius: 4px;
        }

        .welcome-screen {
            padding: 40px;
            text-align: center;
        }

        .welcome-screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #00d4ff;
        }

        .welcome-screen p {
            font-size: 18px;
            opacity: 0.8;
            margin: 10px 0;
        }

        .gesture-toggle-button {
            margin-top: 20px;
            padding: 12px 25px;
            background: rgba(0, 212, 255, 0.3);
            border: 2px solid #00d4ff;
            border-radius: 10px;
            color: #00d4ff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gesture-toggle-button:hover {
            background: rgba(0, 212, 255, 0.5);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            transform: scale(1.05);
        }

        .gesture-toggle-button.active {
            background: rgba(0, 255, 0, 0.3);
            border-color: #00ff00;
        }

        .gesture-toggle-button.stopping {
            background: rgba(255, 165, 0, 0.3);
            border-color: #ffaa00;
        }
    </style>
</head>
<body>
    <div class="jarvis-container">
        <div class="header">
            <div class="logo">‚ö° JARVIS SYSTEM</div>
            <div class="status-indicators">
                <div class="status-indicator">
                    <div class="status-dot inactive" id="gestureStatus"></div>
                    <span>Gesture Control</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot inactive" id="voiceStatus"></div>
                    <span>Voice Output</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot inactive" id="sttStatus"></div>
                    <span>Voice Input</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot active" id="aiStatus"></div>
                    <span>AI Ready</span>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3 style="margin-bottom: 20px;">Tools</h3>
            <button class="tool-button active" data-tool="chat">üí¨ AI Chat</button>
            <button class="tool-button" data-tool="draw">üé® Drawing Tool</button>
            <button class="tool-button" data-tool="3d">üßä 3D Model Editor</button>
            <button class="tool-button" data-tool="browser">üåê Web Browser</button>
            
            <h3 style="margin: 30px 0 20px 0;">Hand Tracking</h3>
            <button class="gesture-toggle-button" id="gestureToggleBtn" onclick="toggleGestureControl()">
                üé• Start Hand Tracking
            </button>
            
            <div style="font-size: 12px; line-height: 1.8; margin-top: 15px;">
                <p><strong style="color: #00ff00;">RIGHT HAND:</strong> Primary</p>
                <p>üëÜ Point: Move cursor</p>
                <p>‚úåÔ∏è Peace: Click</p>
                <p>üëå Pinch: Draw/Interact</p>
                <p>ü§ö Open: Show Keyboard</p>
                <p>‚úä Fist: Hide Keyboard</p>
            </div>
        </div>

        <div class="main-workspace">
            <video id="input_video" autoplay playsinline></video>
            <canvas id="output_canvas"></canvas>

            <!-- Chat Workspace -->
            <div id="chatWorkspace" class="workspace-content active">
                <div class="welcome-screen">
                    <h1>Welcome to JARVIS</h1>
                    <p style="font-size: 20px;">Advanced AI-Powered Assistant System</p>
                    <p>Features: Hand Tracking ‚Ä¢ 3D Modeling ‚Ä¢ Drawing ‚Ä¢ Web Browsing</p>
                    <p style="margin-top: 30px; font-size: 14px; opacity: 0.6;">
                        Toggle hand tracking on/off anytime from the sidebar
                    </p>
                </div>
            </div>

            <!-- Drawing Workspace -->
            <div id="drawWorkspace" class="workspace-content">
                <canvas id="drawingCanvas"></canvas>
                <div class="drawing-tools">
                    <h4 style="margin-bottom: 10px;">Drawing Tools</h4>
                    <div class="color-picker">
                        <label style="color: #00d4ff;">Color:</label><br>
                        <input type="color" id="drawColor" value="#00d4ff">
                    </div>
                    <div class="size-picker">
                        <label style="color: #00d4ff;">Brush: <span id="sizeValue">5</span>px</label><br>
                        <input type="range" id="drawSize" min="1" max="50" value="5" style="width: 100%;">
                    </div>
                    <button class="control-button" onclick="clearDrawing()">üóëÔ∏è Clear Canvas</button>
                    <button class="control-button" onclick="saveDrawing()">üíæ Save Drawing</button>
                </div>
            </div>

            <!-- 3D Workspace -->
            <div id="3dWorkspace" class="workspace-content">
                <div id="modelViewer"></div>
                <div class="model-controls-panel">
                    <!-- Add Objects Section -->
                    <div class="model-controls-section">
                        <h4>‚ûï Add Objects</h4>
                        <button class="control-button" onclick="add3DShape('cube')">üü¶ Cube</button>
                        <button class="control-button" onclick="add3DShape('sphere')">üîµ Sphere</button>
                        <button class="control-button" onclick="add3DShape('cylinder')">üõ¢Ô∏è Cylinder</button>
                        <button class="control-button" onclick="add3DShape('cone')">üî∫ Cone</button>
                        <button class="control-button" onclick="add3DShape('torus')">üç© Torus</button>
                    </div>

                    <!-- Object List Section -->
                    <div class="model-controls-section">
                        <h4>üì¶ Objects (<span id="objectCount">0</span>)</h4>
                        <div class="object-list" id="objectList">
                            <p style="font-size: 11px; opacity: 0.6;">No objects yet</p>
                        </div>
                    </div>

                    <!-- Edit Selected Object -->
                    <div class="model-controls-section" id="editSection" style="display: none;">
                        <h4>‚úèÔ∏è Edit Selected</h4>
                        
                        <div class="control-label">
                            <span>Position X:</span>
                            <span id="posXValue">0</span>
                        </div>
                        <input type="range" class="control-slider" id="posX" min="-5" max="5" step="0.1" value="0">
                        
                        <div class="control-label">
                            <span>Position Y:</span>
                            <span id="posYValue">0</span>
                        </div>
                        <input type="range" class="control-slider" id="posY" min="-5" max="5" step="0.1" value="0">
                        
                        <div class="control-label">
                            <span>Position Z:</span>
                            <span id="posZValue">0</span>
                        </div>
                        <input type="range" class="control-slider" id="posZ" min="-5" max="5" step="0.1" value="0">
                        
                        <div class="control-label">
                            <span>Scale:</span>
                            <span id="scaleValue">1.0</span>
                        </div>
                        <input type="range" class="control-slider" id="scaleSlider" min="0.1" max="3" step="0.1" value="1">
                        
                        <div class="control-label">
                            <span>Rotation X:</span>
                            <span id="rotXValue">0¬∞</span>
                        </div>
                        <input type="range" class="control-slider" id="rotX" min="0" max="360" step="1" value="0">
                        
                        <div class="control-label">
                            <span>Rotation Y:</span>
                            <span id="rotYValue">0¬∞</span>
                        </div>
                        <input type="range" class="control-slider" id="rotY" min="0" max="360" step="1" value="0">
                        
                        <div class="control-label">
                            <span>Rotation Z:</span>
                            <span id="rotZValue">0¬∞</span>
                        </div>
                        <input type="range" class="control-slider" id="rotZ" min="0" max="360" step="1" value="0">
                        
                        <div class="control-label">
                            <span>Color:</span>
                        </div>
                        <input type="color" id="objectColor" style="width: 100%; height: 30px; cursor: pointer;">
                        
                        <button class="control-button" style="margin-top: 10px;" onclick="duplicateSelected()">üìã Duplicate</button>
                        <button class="control-button" onclick="deleteSelected()">üóëÔ∏è Delete</button>
                    </div>

                    <!-- Scene Controls -->
                    <div class="model-controls-section">
                        <h4>üé¨ Scene Controls</h4>
                        <button class="control-button small" onclick="toggleAnimation()">‚ñ∂Ô∏è Animate</button>
                        <button class="control-button small" onclick="resetCamera()">üì∑ Reset View</button>
                        <button class="control-button" onclick="clear3DScene()">üóëÔ∏è Clear All</button>
                        <button class="control-button" onclick="save3DModel()">üíæ Save Image</button>
                    </div>
                </div>
            </div>

            <!-- Browser Workspace -->
            <div id="browserWorkspace" class="workspace-content">
                <div class="browser-controls">
                    <input type="text" class="url-input" id="urlInput" placeholder="Enter URL (e.g., wikipedia.org)">
                    <button class="control-button" onclick="loadWebsite()" style="margin: 0;">Go</button>
                </div>
                <iframe id="browserFrame" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">
                JARVIS Chat
                <div>
                    <button class="toggle-button" id="voiceToggle" onclick="toggleVoice()">üîä Voice</button>
                    <button class="toggle-button" id="sttToggle" onclick="toggleSTT()">üé§ STT</button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message jarvis">
                    Hello! I'm JARVIS. I now have advanced 3D modeling capabilities! You can edit, rotate, scale, and color objects.
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
                <button class="send-button" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Virtual Keyboard -->
    <div class="virtual-keyboard" id="virtualKeyboard">
        <div class="keyboard-row">
            <div class="key" onclick="typeKey('1')">1</div>
            <div class="key" onclick="typeKey('2')">2</div>
            <div class="key" onclick="typeKey('3')">3</div>
            <div class="key" onclick="typeKey('4')">4</div>
            <div class="key" onclick="typeKey('5')">5</div>
            <div class="key" onclick="typeKey('6')">6</div>
            <div class="key" onclick="typeKey('7')">7</div>
            <div class="key" onclick="typeKey('8')">8</div>
            <div class="key" onclick="typeKey('9')">9</div>
            <div class="key" onclick="typeKey('0')">0</div>
        </div>
        <div class="keyboard-row">
            <div class="key" onclick="typeKey('q')">Q</div>
            <div class="key" onclick="typeKey('w')">W</div>
            <div class="key" onclick="typeKey('e')">E</div>
            <div class="key" onclick="typeKey('r')">R</div>
            <div class="key" onclick="typeKey('t')">T</div>
            <div class="key" onclick="typeKey('y')">Y</div>
            <div class="key" onclick="typeKey('u')">U</div>
            <div class="key" onclick="typeKey('i')">I</div>
            <div class="key" onclick="typeKey('o')">O</div>
            <div class="key" onclick="typeKey('p')">P</div>
        </div>
        <div class="keyboard-row">
            <div class="key" onclick="typeKey('a')">A</div>
            <div class="key" onclick="typeKey('s')">S</div>
            <div class="key" onclick="typeKey('d')">D</div>
            <div class="key" onclick="typeKey('f')">F</div>
            <div class="key" onclick="typeKey('g')">G</div>
            <div class="key" onclick="typeKey('h')">H</div>
            <div class="key" onclick="typeKey('j')">J</div>
            <div class="key" onclick="typeKey('k')">K</div>
            <div class="key" onclick="typeKey('l')">L</div>
        </div>
        <div class="keyboard-row">
            <div class="key" onclick="typeKey('z')">Z</div>
            <div class="key" onclick="typeKey('x')">X</div>
            <div class="key" onclick="typeKey('c')">C</div>
            <div class="key" onclick="typeKey('v')">V</div>
            <div class="key" onclick="typeKey('b')">B</div>
            <div class="key" onclick="typeKey('n')">N</div>
            <div class="key" onclick="typeKey('m')">M</div>
            <div class="key" onclick="typeKey('BACK')">‚å´</div>
        </div>
        <div class="keyboard-row">
            <div class="key" onclick="typeKey('.')">.</div>
            <div class="key" onclick="typeKey(',')">,</div>
            <div class="key space" onclick="typeKey(' ')">Space</div>
            <div class="key" onclick="typeKey('?')">?</div>
            <div class="key" onclick="toggleKeyboard()">Close</div>
        </div>
    </div>

    <!-- Gesture Indicator -->
    <div class="gesture-indicator" id="gestureIndicator">
        <strong style="font-size: 12px;">Hand Tracking:</strong>
        <div class="gesture-text" id="gestureText" style="color: #00ff00;">Active</div>
        <div id="handStatus">
            <div class="hand-info right" id="rightHandInfo" style="display: none;">
                <strong>RIGHT:</strong> <span id="rightGesture">-</span>
            </div>
            <div class="hand-info left" id="leftHandInfo" style="display: none;">
                <strong>LEFT:</strong> <span id="leftGesture">-</span>
            </div>
        </div>
        <div class="gesture-help">
            Point=Move ‚Ä¢ Peace=Click ‚Ä¢ Pinch=Draw
        </div>
    </div>

    <!-- Virtual Cursor -->
    <div class="virtual-cursor" id="virtualCursor"></div>

    <script>
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        let scene, camera, renderer;
        let objects = [];
        let selectedObject = null;
        let objectIdCounter = 0;
        let animationEnabled = true;
        
        let drawingCtx;
        let voiceEnabled = false;
        let sttEnabled = false;
        let gestureEnabled = false;
        let currentTool = 'chat';
        let recognition = null;
        let conversationHistory = [];
        
        // Gesture tracking
        let hands;
        let camera_instance;
        let videoElement;
        let canvasElement;
        let canvasCtx;
        let cursorX = window.innerWidth / 2;
        let cursorY = window.innerHeight / 2;
        let isDrawingWithGesture = false;
        let clickCooldown = false;
        let lastDrawX = 0;
        let lastDrawY = 0;

        // ========================================
        // INITIALIZATION
        // ========================================
        window.onload = function() {
            console.log('Initializing JARVIS...');
            initializeDrawing();
            initialize3D();
            initializeSpeechRecognition();
            setupEventListeners();
            setup3DEventListeners();
            updateAllStatus();
            
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = () => {
                    speechSynthesis.getVoices();
                };
            }
            
            console.log('JARVIS initialized successfully');
        };

        // ========================================
        // GESTURE CONTROL TOGGLE
        // ========================================
        async function toggleGestureControl() {
            if (gestureEnabled) {
                stopGestureControl();
            } else {
                await startGestureControl();
            }
        }

        async function startGestureControl() {
            if (gestureEnabled) return;

            try {
                const button = document.getElementById('gestureToggleBtn');
                button.textContent = '‚è≥ Starting...';
                button.classList.add('stopping');

                videoElement = document.getElementById('input_video');
                canvasElement = document.getElementById('output_canvas');
                canvasCtx = canvasElement.getContext('2d');

                canvasElement.width = 240;
                canvasElement.height = 180;

                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });

                hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.7
                });

                hands.onResults(onHandResults);

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720 }
                });
                
                videoElement.srcObject = stream;
                videoElement.classList.add('active');
                canvasElement.classList.add('active');

                camera_instance = new Camera(videoElement, {
                    onFrame: async () => {
                        await hands.send({ image: videoElement });
                    },
                    width: 1280,
                    height: 720
                });

                camera_instance.start();

                gestureEnabled = true;
                updateAllStatus();
                
                button.textContent = 'üõë Stop Hand Tracking';
                button.classList.remove('stopping');
                button.classList.add('active');
                
                document.getElementById('virtualCursor').classList.add('active');
                document.getElementById('gestureIndicator').classList.add('active');
                
                addChatMessage('‚úÖ Hand tracking started! Use your RIGHT hand as primary controller.', 'jarvis');
                speak('Hand tracking started');

            } catch (error) {
                console.error('Camera error:', error);
                addChatMessage('‚ùå Camera access denied. Please allow camera permissions.', 'jarvis');
                speak('Camera access denied');
                
                const button = document.getElementById('gestureToggleBtn');
                button.textContent = 'üé• Start Hand Tracking';
                button.classList.remove('stopping', 'active');
            }
        }

        function stopGestureControl() {
            if (!gestureEnabled) return;

            // Stop camera
            if (camera_instance) {
                camera_instance.stop();
            }

            // Stop video stream
            if (videoElement && videoElement.srcObject) {
                const tracks = videoElement.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                videoElement.srcObject = null;
            }

            videoElement.classList.remove('active');
            canvasElement.classList.remove('active');
            document.getElementById('virtualCursor').classList.remove('active');
            document.getElementById('gestureIndicator').classList.remove('active');

            gestureEnabled = false;
            updateAllStatus();

            const button = document.getElementById('gestureToggleBtn');
            button.textContent = 'üé• Start Hand Tracking';
            button.classList.remove('active', 'stopping');

            addChatMessage('‚èπÔ∏è Hand tracking stopped', 'jarvis');
            speak('Hand tracking stopped');
        }

        function onHandResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            let rightHandData = null;
            let leftHandData = null;

            if (results.multiHandLandmarks && results.multiHandedness) {
                for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                    const landmarks = results.multiHandLandmarks[i];
                    const handedness = results.multiHandedness[i].label;
                    const isRightHand = (handedness === 'Left');
                    
                    const color = isRightHand ? '#00FF00' : '#FFAA00';
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, 
                        {color: color, lineWidth: 2});
                    drawLandmarks(canvasCtx, landmarks, 
                        {color: '#FF0000', lineWidth: 1, radius: 2});

                    if (isRightHand) {
                        rightHandData = landmarks;
                        document.getElementById('rightHandInfo').style.display = 'block';
                    } else {
                        leftHandData = landmarks;
                        document.getElementById('leftHandInfo').style.display = 'block';
                    }
                }

                if (rightHandData) {
                    processGesture(rightHandData, true);
                } else if (leftHandData) {
                    processGesture(leftHandData, false);
                }

            } else {
                document.getElementById('gestureText').textContent = 'No Hands';
                document.getElementById('rightHandInfo').style.display = 'none';
                document.getElementById('leftHandInfo').style.display = 'none';
            }

            canvasCtx.restore();
        }

        function processGesture(landmarks, isRightHand) {
            const fingers = getFingersUp(landmarks);
            const fingerCount = fingers.reduce((a, b) => a + b, 0);
            
            const indexTip = landmarks[8];
            cursorX = (1 - indexTip.x) * window.innerWidth;
            cursorY = indexTip.y * window.innerHeight;
            
            const cursor = document.getElementById('virtualCursor');
            cursor.style.left = cursorX + 'px';
            cursor.style.top = cursorY + 'px';

            const thumbTip = landmarks[4];
            const distance = Math.sqrt(
                Math.pow(indexTip.x - thumbTip.x, 2) + 
                Math.pow(indexTip.y - thumbTip.y, 2)
            );
            const isPinching = distance < 0.05;

            let gesture = '';
            
            if (fingerCount === 0) {
                gesture = '‚úä Fist';
                hideKeyboard();
                stopDrawingGesture();
            } else if (fingerCount === 5) {
                gesture = 'ü§ö Open';
                showKeyboard();
                stopDrawingGesture();
            } else if (fingerCount === 1 && fingers[1]) {
                gesture = 'üëÜ Point';
                stopDrawingGesture();
            } else if (fingerCount === 2 && fingers[1] && fingers[2]) {
                gesture = '‚úåÔ∏è Peace';
                handleGestureClick();
                stopDrawingGesture();
            } else if (isPinching) {
                gesture = 'üëå Pinch';
                handleDrawGesture();
            } else {
                stopDrawingGesture();
            }

            const handLabel = isRightHand ? 'RIGHT' : 'LEFT';
            document.getElementById('gestureText').textContent = `${handLabel}`;
            
            if (isRightHand) {
                document.getElementById('rightGesture').textContent = gesture;
            } else {
                document.getElementById('leftGesture').textContent = gesture;
            }
        }

        function getFingersUp(landmarks) {
            const fingers = [];
            
            if (landmarks[4].x < landmarks[3].x) {
                fingers.push(1);
            } else {
                fingers.push(0);
            }
            
            const fingerTips = [8, 12, 16, 20];
            const fingerPips = [6, 10, 14, 18];
            
            for (let i = 0; i < fingerTips.length; i++) {
                if (landmarks[fingerTips[i]].y < landmarks[fingerPips[i]].y) {
                    fingers.push(1);
                } else {
                    fingers.push(0);
                }
            }
            
            return fingers;
        }

        function handleGestureClick() {
            if (clickCooldown) return;
            
            clickCooldown = true;
            const cursor = document.getElementById('virtualCursor');
            cursor.classList.add('clicking');
            
            const element = document.elementFromPoint(cursorX, cursorY);
            if (element && element.click) {
                element.click();
            }
            
            setTimeout(() => {
                cursor.classList.remove('clicking');
                clickCooldown = false;
            }, 500);
        }

        function handleDrawGesture() {
            if (currentTool !== 'draw') return;
            
            const cursor = document.getElementById('virtualCursor');
            cursor.classList.add('drawing');
            
            const canvas = document.getElementById('drawingCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = cursorX - rect.left;
            const y = cursorY - rect.top;
            
            if (x < 0 || x > canvas.width || y < 0 || y > canvas.height) {
                isDrawingWithGesture = false;
                return;
            }
            
            if (!isDrawingWithGesture) {
                isDrawingWithGesture = true;
                lastDrawX = x;
                lastDrawY = y;
            } else {
                const color = document.getElementById('drawColor').value;
                const size = document.getElementById('drawSize').value;
                
                drawingCtx.strokeStyle = color;
                drawingCtx.lineWidth = size;
                drawingCtx.lineCap = 'round';
                drawingCtx.lineJoin = 'round';
                
                drawingCtx.beginPath();
                drawingCtx.moveTo(lastDrawX, lastDrawY);
                drawingCtx.lineTo(x, y);
                drawingCtx.stroke();
                
                lastDrawX = x;
                lastDrawY = y;
            }
        }

        function stopDrawingGesture() {
            if (isDrawingWithGesture) {
                isDrawingWithGesture = false;
                const cursor = document.getElementById('virtualCursor');
                cursor.classList.remove('drawing');
            }
        }

        // ========================================
        // DRAWING TOOL
        // ========================================
        function initializeDrawing() {
            const canvas = document.getElementById('drawingCanvas');
            const workspace = document.getElementById('drawWorkspace');
            
            if (!workspace) return;
            
            canvas.width = workspace.clientWidth;
            canvas.height = workspace.clientHeight;
            drawingCtx = canvas.getContext('2d');
            
            drawingCtx.lineCap = 'round';
            drawingCtx.lineJoin = 'round';
            
            let drawing = false;
            let lastX = 0, lastY = 0;
            
            canvas.addEventListener('mousedown', (e) => {
                drawing = true;
                const rect = canvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!drawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const color = document.getElementById('drawColor').value;
                const size = document.getElementById('drawSize').value;
                
                drawingCtx.strokeStyle = color;
                drawingCtx.lineWidth = size;
                
                drawingCtx.beginPath();
                drawingCtx.moveTo(lastX, lastY);
                drawingCtx.lineTo(x, y);
                drawingCtx.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            canvas.addEventListener('mouseup', () => { drawing = false; });
            canvas.addEventListener('mouseout', () => { drawing = false; });
            
            document.getElementById('drawSize').addEventListener('input', (e) => {
                document.getElementById('sizeValue').textContent = e.target.value;
            });
        }

        function clearDrawing() {
            const canvas = document.getElementById('drawingCanvas');
            drawingCtx.clearRect(0, 0, canvas.width, canvas.height);
            addChatMessage('üóëÔ∏è Drawing cleared!', 'jarvis');
            speak('Drawing cleared');
        }

        function saveDrawing() {
            const canvas = document.getElementById('drawingCanvas');
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            link.download = `jarvis-drawing-${timestamp}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            addChatMessage('üíæ Drawing saved!', 'jarvis');
            speak('Drawing saved');
        }

        // ========================================
        // 3D MODEL CREATOR - ADVANCED
        // ========================================
        function initialize3D() {
            const container = document.getElementById('modelViewer');
            if (!container) return;
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e27);
            
            camera = new THREE.PerspectiveCamera(
                75,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera.position.set(5, 5, 8);
            camera.lookAt(0, 0, 0);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            const directionalLight2 = new THREE.DirectionalLight(0x00d4ff, 0.5);
            directionalLight2.position.set(-5, 3, -5);
            scene.add(directionalLight2);
            
            // Grid helper
            const gridHelper = new THREE.GridHelper(10, 10, 0x00d4ff, 0x444444);
            scene.add(gridHelper);
            
            animate3D();
            console.log('3D editor initialized');
        }

        function add3DShape(type) {
            if (!scene) return;
            
            let geometry;
            const material = new THREE.MeshPhongMaterial({ 
                color: Math.random() * 0xffffff,
                shininess: 100,
                specular: 0x555555
            });
            
            switch(type) {
                case 'cube':
                    geometry = new THREE.BoxGeometry(1, 1, 1);
                    break;
                case 'sphere':
                    geometry = new THREE.SphereGeometry(0.6, 32, 32);
                    break;
                case 'cylinder':
                    geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
                    break;
                case 'cone':
                    geometry = new THREE.ConeGeometry(0.5, 1, 32);
                    break;
                case 'torus':
                    geometry = new THREE.TorusGeometry(0.5, 0.2, 16, 100);
                    break;
            }
            
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(
                (Math.random() - 0.5) * 3,
                (Math.random() - 0.5) * 2,
                (Math.random() - 0.5) * 3
            );
            
            mesh.userData.id = objectIdCounter++;
            mesh.userData.type = type;
            mesh.userData.originalColor = material.color.getHex();
            
            scene.add(mesh);
            objects.push(mesh);
            
            updateObjectList();
            addChatMessage(`‚úÖ Added ${type.toUpperCase()}`, 'jarvis');
            speak(`Added ${type}`);
        }

        function updateObjectList() {
            const list = document.getElementById('objectList');
            const count = document.getElementById('objectCount');
            
            count.textContent = objects.length;
            
            if (objects.length === 0) {
                list.innerHTML = '<p style="font-size: 11px; opacity: 0.6;">No objects</p>';
                return;
            }
            
            list.innerHTML = '';
            objects.forEach((obj, index) => {
                const item = document.createElement('div');
                item.className = 'object-item';
                if (selectedObject === obj) {
                    item.classList.add('selected');
                }
                
                item.innerHTML = `
                    <span>${obj.userData.type} #${obj.userData.id}</span>
                    <span class="delete-object" onclick="deleteObject(${index}); event.stopPropagation();">‚úï</span>
                `;
                
                item.onclick = () => selectObject(obj);
                list.appendChild(item);
            });
        }

        function selectObject(obj) {
            // Deselect previous
            if (selectedObject && selectedObject.userData.outline) {
                scene.remove(selectedObject.userData.outline);
                delete selectedObject.userData.outline;
            }
            
            selectedObject = obj;
            
            // Add outline
            const outlineGeometry = obj.geometry.clone();
            const outlineMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x00ff00, 
                side: THREE.BackSide 
            });
            const outline = new THREE.Mesh(outlineGeometry, outlineMaterial);
            outline.scale.multiplyScalar(1.1);
            obj.add(outline);
            obj.userData.outline = outline;
            
            // Update UI
            updateObjectList();
            showEditPanel();
            
            addChatMessage(`‚úèÔ∏è Selected ${obj.userData.type} #${obj.userData.id}`, 'jarvis');
        }

        function showEditPanel() {
            if (!selectedObject) return;
            
            const panel = document.getElementById('editSection');
            panel.style.display = 'block';
            
            // Update sliders
            document.getElementById('posX').value = selectedObject.position.x;
            document.getElementById('posY').value = selectedObject.position.y;
            document.getElementById('posZ').value = selectedObject.position.z;
            document.getElementById('scaleSlider').value = selectedObject.scale.x;
            document.getElementById('rotX').value = (selectedObject.rotation.x * 180 / Math.PI) % 360;
            document.getElementById('rotY').value = (selectedObject.rotation.y * 180 / Math.PI) % 360;
            document.getElementById('rotZ').value = (selectedObject.rotation.z * 180 / Math.PI) % 360;
            
            const color = '#' + selectedObject.material.color.getHexString();
            document.getElementById('objectColor').value = color;
            
            updateSliderValues();
        }

        function setup3DEventListeners() {
            // Position sliders
            ['posX', 'posY', 'posZ'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    if (!selectedObject) return;
                    const axis = id.replace('pos', '').toLowerCase();
                    selectedObject.position[axis] = parseFloat(e.target.value);
                    updateSliderValues();
                });
            });
            
            // Scale slider
            document.getElementById('scaleSlider').addEventListener('input', (e) => {
                if (!selectedObject) return;
                const scale = parseFloat(e.target.value);
                selectedObject.scale.set(scale, scale, scale);
                updateSliderValues();
            });
            
            // Rotation sliders
            ['rotX', 'rotY', 'rotZ'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    if (!selectedObject) return;
                    const axis = id.replace('rot', '').toLowerCase();
                    selectedObject.rotation[axis] = parseFloat(e.target.value) * Math.PI / 180;
                    updateSliderValues();
                });
            });
            
            // Color picker
            document.getElementById('objectColor').addEventListener('input', (e) => {
                if (!selectedObject) return;
                selectedObject.material.color.setStyle(e.target.value);
            });
        }

        function updateSliderValues() {
            if (!selectedObject) return;
            
            document.getElementById('posXValue').textContent = selectedObject.position.x.toFixed(1);
            document.getElementById('posYValue').textContent = selectedObject.position.y.toFixed(1);
            document.getElementById('posZValue').textContent = selectedObject.position.z.toFixed(1);
            document.getElementById('scaleValue').textContent = selectedObject.scale.x.toFixed(1);
            document.getElementById('rotXValue').textContent = Math.round(selectedObject.rotation.x * 180 / Math.PI) + '¬∞';
            document.getElementById('rotYValue').textContent = Math.round(selectedObject.rotation.y * 180 / Math.PI) + '¬∞';
            document.getElementById('rotZValue').textContent = Math.round(selectedObject.rotation.z * 180 / Math.PI) + '¬∞';
        }

        function duplicateSelected() {
            if (!selectedObject) return;
            
            const geometry = selectedObject.geometry.clone();
            const material = selectedObject.material.clone();
            const duplicate = new THREE.Mesh(geometry, material);
            
            duplicate.position.copy(selectedObject.position);
            duplicate.position.x += 1;
            duplicate.rotation.copy(selectedObject.rotation);
            duplicate.scale.copy(selectedObject.scale);
            
            duplicate.userData.id = objectIdCounter++;
            duplicate.userData.type = selectedObject.userData.type;
            
            scene.add(duplicate);
            objects.push(duplicate);
            
            selectObject(duplicate);
            addChatMessage('üìã Object duplicated', 'jarvis');
            speak('Duplicated');
        }

        function deleteSelected() {
            if (!selectedObject) return;
            
            const index = objects.indexOf(selectedObject);
            if (index > -1) {
                deleteObject(index);
            }
        }

        function deleteObject(index) {
            const obj = objects[index];
            scene.remove(obj);
            obj.geometry.dispose();
            obj.material.dispose();
            objects.splice(index, 1);
            
            if (selectedObject === obj) {
                selectedObject = null;
                document.getElementById('editSection').style.display = 'none';
            }
            
            updateObjectList();
            addChatMessage('üóëÔ∏è Object deleted', 'jarvis');
            speak('Deleted');
        }

        function toggleAnimation() {
            animationEnabled = !animationEnabled;
            addChatMessage(animationEnabled ? '‚ñ∂Ô∏è Animation enabled' : '‚è∏Ô∏è Animation paused', 'jarvis');
        }

        function resetCamera() {
            camera.position.set(5, 5, 8);
            camera.lookAt(0, 0, 0);
            addChatMessage('üì∑ Camera reset', 'jarvis');
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            
            if (animationEnabled) {
                objects.forEach(obj => {
                    if (obj !== selectedObject) {
                        obj.rotation.x += 0.003;
                        obj.rotation.y += 0.005;
                    }
                });
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        function clear3DScene() {
            objects.forEach(obj => {
                scene.remove(obj);
                obj.geometry.dispose();
                obj.material.dispose();
            });
            objects = [];
            selectedObject = null;
            document.getElementById('editSection').style.display = 'none';
            updateObjectList();
            addChatMessage('üóëÔ∏è All objects removed', 'jarvis');
            speak('Scene cleared');
        }

        function save3DModel() {
            if (!renderer) return;
            
            const canvas = renderer.domElement;
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            link.download = `jarvis-3d-${timestamp}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            addChatMessage('üíæ 3D scene saved!', 'jarvis');
            speak('Scene saved');
        }

        // ========================================
        // SPEECH RECOGNITION
        // ========================================
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    if (finalTranscript) {
                        document.getElementById('chatInput').value = finalTranscript;
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech error:', event.error);
                };
                
                recognition.onend = () => {
                    if (sttEnabled) {
                        try { recognition.start(); } catch (e) {}
                    }
                };
            }
        }

        function toggleSTT() {
            sttEnabled = !sttEnabled;
            const button = document.getElementById('sttToggle');
            
            if (sttEnabled && recognition) {
                try {
                    recognition.start();
                    button.classList.add('active');
                    addChatMessage('üé§ Voice input ON', 'jarvis');
                    speak('Voice input on');
                } catch (e) {}
            } else if (recognition) {
                recognition.stop();
                button.classList.remove('active');
                addChatMessage('üé§ Voice input OFF', 'jarvis');
            }
            
            updateAllStatus();
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            const button = document.getElementById('voiceToggle');
            
            if (voiceEnabled) {
                button.classList.add('active');
                speak('Voice output on');
            } else {
                button.classList.remove('active');
                window.speechSynthesis.cancel();
            }
            
            updateAllStatus();
        }

        function speak(text) {
            if (!voiceEnabled) return;
            
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => 
                voice.lang.includes('en-GB') || voice.lang.includes('en-US')
            ) || voices[0];
            
            utterance.voice = preferredVoice;
            window.speechSynthesis.speak(utterance);
        }

        // ========================================
        // AI CHAT
        // ========================================
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            conversationHistory.push({ role: 'user', content: message });
            
            const typingMsg = addChatMessage('...', 'jarvis');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-5-20250929',
                        max_tokens: 1000,
                        messages: conversationHistory
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const aiResponse = data.content[0].text;
                    
                    typingMsg.remove();
                    conversationHistory.push({ role: 'assistant', content: aiResponse });
                    addChatMessage(aiResponse, 'jarvis');
                    speak(aiResponse);
                } else {
                    throw new Error('API failed');
                }
                
            } catch (error) {
                typingMsg.remove();
                const fallback = "I'm here to help! Try using the 3D editor to create and modify objects, or the drawing tool for artwork!";
                addChatMessage(fallback, 'jarvis');
                speak(fallback);
            }
        }

        function addChatMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageDiv;
        }

        // ========================================
        // WEB BROWSER
        // ========================================
        function loadWebsite() {
            let url = document.getElementById('urlInput').value.trim();
            const iframe = document.getElementById('browserFrame');
            
            if (!url) {
                addChatMessage('‚ùå Enter a URL', 'jarvis');
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            
            iframe.src = url;
            addChatMessage(`üåê Loading: ${url}`, 'jarvis');
            speak('Loading website');
        }

        // ========================================
        // KEYBOARD
        // ========================================
        function toggleKeyboard() {
            const keyboard = document.getElementById('virtualKeyboard');
            keyboard.classList.toggle('active');
        }

        function showKeyboard() {
            const keyboard = document.getElementById('virtualKeyboard');
            if (!keyboard.classList.contains('active')) {
                keyboard.classList.add('active');
                addChatMessage('‚å®Ô∏è Keyboard opened', 'jarvis');
            }
        }

        function hideKeyboard() {
            const keyboard = document.getElementById('virtualKeyboard');
            if (keyboard.classList.contains('active')) {
                keyboard.classList.remove('active');
                addChatMessage('‚å®Ô∏è Keyboard closed', 'jarvis');
            }
        }

        function typeKey(key) {
            const input = document.getElementById('chatInput');
            if (key === 'BACK') {
                input.value = input.value.slice(0, -1);
            } else {
                input.value += key;
            }
            input.focus();
        }

        // ========================================
        // TOOL SWITCHING
        // ========================================
        function setupEventListeners() {
            const toolButtons = document.querySelectorAll('.tool-button');
            toolButtons.forEach(button => {
                button.addEventListener('click', () => {
                    switchTool(button.dataset.tool);
                });
            });
            
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            document.getElementById('urlInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadWebsite();
            });
        }

        function switchTool(tool) {
            currentTool = tool;
            
            document.querySelectorAll('.tool-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            
            document.querySelectorAll('.workspace-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const workspaceMap = {
                'chat': 'chatWorkspace',
                'draw': 'drawWorkspace',
                '3d': '3dWorkspace',
                'browser': 'browserWorkspace'
            };
            
            const workspace = document.getElementById(workspaceMap[tool]);
            if (workspace) {
                workspace.classList.add('active');
            }
            
            addChatMessage(`üìç ${tool.toUpperCase()} activated`, 'jarvis');
            speak(`${tool} tool`);
        }

        function updateAllStatus() {
            document.getElementById('gestureStatus').className = 
                'status-dot ' + (gestureEnabled ? 'active' : 'inactive');
            document.getElementById('voiceStatus').className = 
                'status-dot ' + (voiceEnabled ? 'active' : 'inactive');
            document.getElementById('sttStatus').className = 
                'status-dot ' + (sttEnabled ? 'active' : 'inactive');
        }

        // ========================================
        // RESIZE
        // ========================================
        window.addEventListener('resize', () => {
            const workspace = document.querySelector('.main-workspace');
            const drawCanvas = document.getElementById('drawingCanvas');
            
            if (drawCanvas && workspace) {
                drawCanvas.width = workspace.clientWidth;
                drawCanvas.height = workspace.clientHeight;
            }
            
            if (renderer && camera) {
                const container = document.getElementById('modelViewer');
                if (container) {
                    renderer.setSize(container.clientWidth, container.clientHeight);
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                }
            }
        });
    </script>
</body>
</html>
